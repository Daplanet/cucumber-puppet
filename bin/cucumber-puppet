#!/usr/bin/env ruby

require 'cucumber-puppet'
require 'cucumber-puppet/helper'
require 'optparse'

include CucumberPuppet::Helper

options = {}
opts = OptionParser.new do |o|
  o.banner = "Usage: cucumber-puppet [options] <feature> [<feature> ...]"

  o.on('-h', '--help', 'Show this message') do
    puts opts
    exit
  end
  # XXX test
  o.on('-v', '--verbose', 'Show files and features loaded') do
    options[:verbose] = true
  end
  o.on('--version', 'Show version number') do
    puts CucumberPuppet::VERSION
    exit
  end
end

begin
  opts.parse!
rescue OptionParser::InvalidOption
  puts opts
  exit 1
end

unless ARGV[0]
  puts opts
  exit 1
end

command = []
command << "cucumber --strict"

cwd = Dir.getwd
root = find_root(cwd)
command << "--require #{root}/features"

abs_root = File.expand_path(root)
ARGV.each do |f|
  if not File.exists?(f)
    puts "No such file or directory: #{f}"
    exit 1
  end

  abs_f = File.expand_path(f).split('/')
  until abs_f.empty?
    if abs_f.last == 'features'
      command << "--require " + abs_f.join('/')
      break
    elsif abs_f.join('/') == abs_root
      break
    end
    abs_f.pop
  end

  command << f
end

system(command.join(' ')) ? exit(0) : exit(1)
