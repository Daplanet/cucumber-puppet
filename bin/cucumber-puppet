#!/usr/bin/env ruby

unless ARGV[0]
  puts "Usage: cucumber-puppet [options] <feature> [<feature> <feature> ...]"
  exit 0
end

command = ""
command << "cucumber "
command << "--strict "

# XXX be more creative, finding this directory
cwd = Dir.getwd

if cwd.match('/features$') and not cwd.match('/modules/')
  # assume: <puppetdir>/features
  features_dir = "."
elsif cwd.match('/features/modules$')
  # assume: <puppetdir>/features/modules
  features_dir = ".."
elsif cwd.match('/features/modules/[^/]*$')
  # assume: <puppetdir>/features/modules/$mod
  features_dir = "../.."
elsif cwd.match('/modules$')
  # assume: <puppetdir>/modules
  features_dir = "../features"
  # XXX this should require only necessary directories according to features
  #     given on the command line
  command << "--require */features "
elsif cwd.match('/modules/[^/]*$')
  # assume: <puppetdir>/modules/$mod
  features_dir = "../../features"
  command << "--require features "
elsif cwd.match('/modules/[^/]*/features$')
  # assume: <puppetdir>/modules/$mod
  features_dir = "../../../features"
  command << "--require . "
else
  # assume: <puppetdir>
  features_dir = "features"
  command << "--require modules/**/features "
end

# load library with basic step definitions
# -> have to load all step definitions explicitly
command << "--require #{features_dir} "

command << ARGV.join(' ')

system(command) ? exit(0) : exit(1)
